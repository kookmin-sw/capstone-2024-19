name: Magician-Server Deploy

on:
  pull_request:
    branches: [ "main" ]
    paths:
    - "magician/**"
env:
  working-directory: ./magician
  image-name: magician-server
  OPENAI_KEY: ${{ secrets.OPENAI_KEY }}
  MAGICIAN_MONGO_HOST: 0.0.0.0
  MAGICIAN_MONGO_PASSWORD: 1234
  MAGICIAN_MONGO_PORT: 27017
  MAGICIAN_MONGO_USERNAME: root

jobs:
  test-build:
    name: Test-Build
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:latest
        env:
          MONGO_INITDB_ROOT_USERNAME: root
          MONGO_INITDB_ROOT_PASSWORD: 1234
          MONGO_INITDB_DATABASE: chat_db
        ports:
          - 27017:27017
    
    steps:
      # 체크아웃
      - name: Checkout Source
        uses: actions/checkout@v4
      
      # 파이썬 환경설정
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11.8
      
      # requirements 다운
      - name: Install requirements.txt
        run: pip install -r requirements.txt
        working-directory: ${{ env.working-directory }}

      # 테스트 실행
      - name: Test with pytest
        run: pytest
        working-directory: ${{ env.working-directory }}
      
      # docker image 빌드
      - name: Build docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.image-name }} .
        working-directory: ${{ env.working-directory }}
        
      # docker hub 로그인
      - name: Login docker hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
  
      # docker hub 퍼블리시
      - name: Publish to docker hub
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.image-name }}
        working-directory: ${{ env.working-directory }}
